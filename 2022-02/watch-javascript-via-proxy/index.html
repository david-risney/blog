<!doctype html>
<html lang="en" class="gradient-background">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Watch JavaScript via Proxy</title>
		<meta name="description" content="Use Proxy to watch how JavaScript uses your objects">
		<link rel="alternate" href="/dave/feed/feed.xml" type="application/atom+xml" title="deletethis.net">
		<link rel="alternate" href="/dave/feed/feed.json" type="application/json" title="deletethis.net">

		<meta name="generator" content="Eleventy v2.0.0">

		<link rel="icon" type="image/svg+xml" href="/dave/img/semicolon.svg">
		<link rel="stylesheet" href="/dave/css/index.css">

		<script>
window.addEventListener("pageswap", async (e) => {
	if (e.viewTransition) {
		if (navigation.activation.from.url === navigation.activation.entry.url) {
			e.viewTransition.types.add('reload');
		} else {
			e.viewTransition.types.add('forwards');
		}
	}
});

window.addEventListener("pagereveal", async (e) => {
	if (e.viewTransition) {
		if (navigation.activation.from.url === navigation.activation.entry.url) {
			e.viewTransition.types.add('reload');
		} else {
			e.viewTransition.types.add('forwards');
		}
	}
});
		</script>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/dave/" class="home-link">deletethis.net<!-- img src="/img/semicolon-dark.svg" class="logo" --></a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/dave/post/">Blog</a></li>
					<li class="nav-item"><a href="/dave/about/">About</a></li>
					<li class="nav-item"><a href="/dave/feed/feed.xml"><!-- img class="logo" src="/img/rss-dark.svg" -->Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			<h1>Watch JavaScript via Proxy</h1>

<ul class="post-metadata">
	<li><time datetime="2022-02-24">24 February 2022</time></li>
	<li><a href="/dave/tags/javascript/" class="post-tag">javascript</a>, </li>
	<li><a href="/dave/tags/proxy/" class="post-tag">proxy</a></li>
</ul>

<p>JavaScript has a type <code>Proxy</code> that lets you intercept all interactions with an object - all property reads, writes, method calls, and so on. One fun thing you can do with this is watch how JavaScript itself interacts with your objects.</p>
<p>If we put a <code>Proxy</code> in another <code>Proxy</code> we can see how JavaScript uses our objects:</p>
<pre class="language-js" tabindex="0"><code class="language-js"><span class="token keyword">function</span> <span class="token function">trace</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <br>        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> property<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <br>            <span class="token function">logCall</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> property<span class="token punctuation">,</span> Reflect<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">,</span> Reflect<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">logCall</span><span class="token punctuation">(</span><span class="token parameter">description<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> fnThis<span class="token punctuation">,</span> <span class="token operator">...</span>fnArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fnThis<span class="token punctuation">,</span> <span class="token operator">...</span>fnArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>description <span class="token operator">+</span> <span class="token string">'\n\t'</span><span class="token punctuation">,</span> <span class="token operator">...</span>fnArgs<span class="token punctuation">,</span> <span class="token string">"\n  -->"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> r<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>description <span class="token operator">+</span> <span class="token string">'\n\t'</span><span class="token punctuation">,</span> <span class="token operator">...</span>fnArgs<span class="token punctuation">,</span> <span class="token string">"\n  -fail->"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">throw</span> e<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span> </code></pre>
<h2 id="how-this-works" tabindex="-1">How this works <a class="header-anchor" href="#how-this-works">#</a></h2>
<p><code>trace</code> returns a <code>Proxy</code> around your object that uses <code>Reflect</code> to perform the normal <code>Proxy</code> operations but then <code>console.log</code> the call.</p>
<p>The constructor for <code>Proxy</code> takes two parameters: first the object you're wrapping, and second an object with functions for all the different kind of object interactions that you want to intercept. Because we want to just log the interaction and not do anything specific we can use a <code>Proxy</code> around <code>Reflect</code> to define this second parameter.</p>
<p>Our inner <code>Proxy</code> implements the handler of the outer <code>Proxy</code>. The handler is supposed to have methods called <code>get</code>, <code>set</code>, <code>apply</code> and others for each operation to intercept. Instead we define our inner <code>Proxy</code>s <code>get</code> to return a function that will perform the operation and log it using <code>logCall</code>. The function we pass in to <code>logCall</code> to run is one of the functions off of <code>Reflect</code>. <code>Reflect</code> defines all the <code>Proxy</code> handler functions <code>get</code>, <code>set</code>, <code>apply</code> and so on but where each just performs those operations. <code>Reflect</code> is like a convenient default for all <code>Proxy</code> handler functions. We want to perform the default operations but additionally log the result so using <code>Reflect</code> is exactly what we want.</p>
<h2 id="what-you-can-do-with-it" tabindex="-1">What you can do with it <a class="header-anchor" href="#what-you-can-do-with-it">#</a></h2>
<p>With that you can call <code>trace</code> with an object and get out a <code>Proxy</code> that acts just like your object but also <code>console.log</code>s every <code>get</code>, <code>set</code>, <code>has</code>, <code>getOwnPropertyDescriptor</code>, and so on that JavaScript asks of your object.</p>
<p>You can watch how <code>Array.sort</code> sorts an array.</p>
<p>Or how <code>Array.toString</code> calls <code>Array.join</code>.</p>
<p>Or how <code>Array.concat</code> checks for <code>Symbol.isConcatSpreadable</code>.</p>
<p>Check out the corresponding ECMAScript standard and you can see how the logged Proxy calls match the standard defined steps for things like <a href="https://tc39.es/ecma262/multipage/indexed-collections.html#sec-array.prototype.sort">Array.sort</a>.</p>
<p>Because I pass objects to <code>console.log</code> DevTools will show you an interactive object in the console. If you try it out the log is easier to understand than as text in the gist:</p>
<pre class="language-log" tabindex="0"><code class="language-log">array get <br>        <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> sort Proxy <span class="token operator">{</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">}</span> <span class="token operator">)</span> <br>    <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span> ƒ sort<span class="token operator">(</span><span class="token operator">)</span> <span class="token operator">{</span> <span class="token punctuation">[</span>native code<span class="token punctuation">]</span> <span class="token operator">}</span></code></pre>
<p>The above is a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get"><code>Proxy</code> handler's get call</a>. The first param is the array <code>(3) [300, 200, 100]</code> on which we will 'get'. The second param is the string <code>'sort'</code> that is the property to get. The third is our proxy.</p>
<p>I haven't tried wrapping the return values in trace Proxy although maybe that would give an even better picture of what's happening.</p>
<p>Various <code>Array</code> functions can operate on a <code>this</code> that is a not an <code>Array</code>. If you're trying to make a non-<code>Array</code> object work with <code>Array</code> functions, then using a <code>Proxy</code> to watch what JavaScript is doing can help debug.</p>
<h3 id="watch-a-for-loop" tabindex="-1">Watch a <code>for</code> loop <a class="header-anchor" href="#watch-a-for-loop">#</a></h3>
<p>But Proxy watching works for other parts of JavaScript and not just standard functions. For example watch a <code>for</code> loop enumerate over your array:</p>
<pre class="language-js" tabindex="0"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'array'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <br><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></code></pre>
<p>And the log:</p>
<pre class="language-log" tabindex="0"><code class="language-log">array ownKeys<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token operator">(</span><span class="token number">4</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">]</span><br>array getPrototypeOf<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token punctuation">[</span>constructor<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> at<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> concat<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> copyWithin<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> fill<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> …<span class="token punctuation">]</span><br>array getOwnPropertyDescriptor<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> <span class="token number">0</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token operator">{</span>value<span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token operator">}</span><br>array getOwnPropertyDescriptor<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> <span class="token number">1</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token operator">{</span>value<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token operator">}</span><br>array getOwnPropertyDescriptor<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> <span class="token number">2</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token operator">{</span>value<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token operator">}</span><br>array getOwnPropertyDescriptor<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> length <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token operator">{</span>value<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> enumerable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> configurable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token operator">}</span></code></pre>
<p>The <code>for</code> loop asks your object for the names of its properties and then the value of each.</p>
<h3 id="watch-instanceof" tabindex="-1">Watch <code>instanceof</code> <a class="header-anchor" href="#watch-instanceof">#</a></h3>
<p>Or <code>instanceof</code> with your proxy on the left hand side</p>
<pre class="language-js" tabindex="0"><code class="language-js">arr <span class="token keyword">instanceof</span> <span class="token class-name">String</span></code></pre>
<p>And watch JavaScript get the prototype of array</p>
<pre class="language-log" tabindex="0"><code class="language-log">array getPrototypeOf<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  <span class="token punctuation">[</span>constructor<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> at<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> concat<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> copyWithin<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> fill<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> …<span class="token punctuation">]</span></code></pre>
<p>Or <code>instanceof</code> with your proxy on the right hand side</p>
<pre class="language-js" tabindex="0"><code class="language-js">String <span class="token keyword">instanceof</span> <span class="token class-name">arr</span></code></pre>
<p>And watch JavaScript ask your array for its <code>Symbol.hasInstance</code> property.</p>
<pre class="language-log" tabindex="0"><code class="language-log">array get<br>    <span class="token operator">(</span><span class="token number">3</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span> Symbol<span class="token operator">(</span>Symbol<span class="token punctuation">.</span>hasInstance<span class="token operator">)</span> Proxy<span class="token operator">(</span>Array<span class="token operator">)</span> <span class="token operator">{</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">}</span> <br>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">></span>  undefined</code></pre>
<p>(Here's a <a href="https://gist.github.com/david-risney/120af7aadb3d3c946e85f46e3869a8eb">related gist</a>.)</p>

<ul class="links-nextprev"><li>Previous: <a href="/dave/2021-11/javascript-arrays-are-neat/">JavaScript Arrays are neat</a></li><li>Next: <a href="/dave/2022-09/404-good-news--bad-news/">404 Good News, Bad News</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- Current page: /dave/2022-02/watch-javascript-via-proxy/ -->
	</body>
</html>
