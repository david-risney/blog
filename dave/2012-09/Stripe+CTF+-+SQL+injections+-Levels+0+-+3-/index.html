<!doctype html>
<html lang="en" class="gradient-background">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Stripe CTF - SQL injections (Levels 0 &amp; 3)</title>
		<meta name="description" content="Dave Risney&#39;s blog on web, coding, and things">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="deletethis.net">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="deletethis.net">

		<meta name="generator" content="Eleventy v2.0.0">

		<link rel="icon" type="image/svg+xml" href="/img/semicolon.svg">

		<style>
		@view-transition { navigation: auto; }

::view-transition-group(*) { animation-duration: 0.2s; }

@keyframes slide-in-from-left { from { translate: -150vw 0; } }
@keyframes slide-in-from-right { from { translate: 150vw 0; } }
@keyframes slide-out-to-left { to { translate: -150vw 0; } }
@keyframes slide-out-to-right { to { translate: 150vw 0; } }
@keyframes scale-up { from { scale: 0; } }
@keyframes scale-down { to { scale: 0; } }
@keyframes fade-in { from { opacity: 0; } }
@keyframes fade-out { to { opacity: 0; } }

html:active-view-transition-type(forwards, backwards) {
	:root { view-transition-name: none; }
	header { view-transition-name: header; }
	main { view-transition-name: main; }
	footer { view-transition-name: footer; }
}

html:active-view-transition-type(forwards) {
	&::view-transition-old(main) { animation-name: fade-out; }
	&::view-transition-new(main) { animation-name: fade-in; }
}

html:active-view-transition-type(backwards) {
	&::view-transition-old(main) { animation-name: fade-out; }
	&::view-transition-new(main) { animation-name: fade-in; }
}

html:active-view-transition-type(reload) {
	&::view-transition-old(root) { animation-name: fade-out; }
	&::view-transition-new(root) { animation-name: fade-in; }
}

/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color-rgb: 255, 255, 255;
	--background-color: rgb(var(--background-color-rgb));
	--background-color-slightly-transparent: rgba(var(--background-color-rgb), 0.75);

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		--background-color-rgb: 21, 32, 43;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--content-border: #dad8d8;
		--content-background: #272727;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}

body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
}
html {
	overflow-y: scroll;
}

@media (width <= 50em) {
	body {
		max-width: 25em;
	}

	#recap-container {
		display: grid;
		grid-template-columns: 1fr;
		grid-template-rows: repeat(1, 1fr);
		gap: 1em;
	}

	#blog-posts {
		grid-column: 1 / 2;
		grid-row: 1 / 2;
	}

	#mastodon-posts {
		grid-column: 1 / 2;
		grid-row: 2 / 3;
	}
}

@media (width > 50em) {
	body {
		max-width: 50em;
	}

	#recap-container {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 1em;
	}

	#blog-posts {
		grid-column: 1 / 2;
	}

	#mastodon-posts {
		grid-column: 2 / 3;
	}
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main {
	padding: 1rem;
	background-color: var(--content-background);
}
main :first-child {
	margin-top: 0;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: break-all;
}

/* Header */
/* header is flex with the items aligned to the ends 
   so that the first item is left aligned and the
   last is right aligned */
#floatyHeader {
	display: grid;
	align-items: center;
	padding: 1em;
	grid-template-columns: 1fr auto;
	grid-template-areas: "home nav";
}

#floatyHeader {
	top: 0px;
	position: sticky;
	height: 4em;
}

#floatyHeader {
	height: 100%;
	width: 100%;
	background: var(--background-color-slightly-transparent);
	backdrop-filter: blur(5px) saturate(200%);
}

#floatyHeader {
	border-bottom: 5px dashed var(--color-gray-20);

	animation: headerChange auto linear;
	animation-timeline: scroll(root);
}

@keyframes headerChange {
	0% { 
		height: 300px; 
		margin-bottom: 0px; 
		grid-template-areas: "home nav";
	}
	15% { 
		height: 4em; 
		margin-bottom: calc(300px - 4em);
		grid-template-areas: "home nav";
	}
	100% { 
		height: 4em; 
		margin-bottom: calc(300px - 4em);
		grid-template-areas: "home nav";
	}
}

.home-link {
	grid-area: home;
	animation: homelinkChange auto linear;
	animation-timeline: scroll(root);
}
@keyframes homelinkChange {
	0% { font-size: 3em; }
	15% { font-size: 1em; }
	100% { font-size: 1em; }
}

nav {
	grid-area: nav;
	height: 100%;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

/* logo is the size of the text and center aligned 
against the center of the text */
.logo {
	width: 1em;
	height: 1em;
	vertical-align: middle;
}
		</style>
		<script>
window.addEventListener("pageswap", async (e) => {
	if (e.viewTransition) {
		if (navigation.activation.from.url === navigation.activation.entry.url) {
			e.viewTransition.types.add('reload');
		} else {
			e.viewTransition.types.add('forwards');
		}
	}
});

window.addEventListener("pagereveal", async (e) => {
	if (e.viewTransition) {
		if (navigation.activation.from.url === navigation.activation.entry.url) {
			e.viewTransition.types.add('reload');
		} else {
			e.viewTransition.types.add('forwards');
		}
	}
});
		</script>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header id="floatyHeader">
			<a href="/dave/" class="home-link">deletethis.net<!-- img src="/img/semicolon-dark.svg" class="logo" --></a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/dave/post/">Blog</a></li>
					<li class="nav-item"><a href="/dave/about/">About</a></li>
					<li class="nav-item"><a href="/feed/feed.xml"><!-- img class="logo" src="/img/rss-dark.svg" -->Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			<h1>Stripe CTF - SQL injections (Levels 0 &amp; 3)</h1>

<ul class="post-metadata">
	<li><time datetime="2012-09-05">05 September 2012</time></li>
</ul>

<div xmlns="http://www.w3.org/1999/xhtml"><div><p><a href="http://davescoolblog.blogspot.com/2012/08/stripe-web-security-ctf-summary.html">Stripe's web security CTF</a>'s <a href="https://stripe-ctf.com/levels/0">level 0</a> and <a href="https://stripe-ctf.com/levels/3">level 3</a> had SQL injection solutions described below.
  </p><h3>
    Level 0
  </h3><h4>
    Code
  </h4><pre><code>app.get('/*', function(req, res) {<br />  var namespace = req.param('namespace');<br /><br />  if (namespace) {<br />    var query = 'SELECT * FROM secrets WHERE key LIKE ? || ".%"';<br />    db.all(query, namespace, function(err, secrets) {</code></pre><h4>
    Issue
  </h4><p>
    There's no input validation on the namespace parameter and it is injected into the SQL query with no encoding applied. This means you can use the '%' character as the namespace which is the
    wildcard character matching all secrets.
  </p><h4>
    Notes
  </h4><p>
    Code review red flag was using strings to query the database. Additional levels made this harder to exploit by using an API with objects to construct a query rather than strings and by running a
    query that only returned a single row, only ran a single command, and didn't just dump out the results of the query to the caller.
  </p><h3>
    Level 3
  </h3><h4>
    Code
  </h4><pre><code>@app.route('/login', methods=['POST'])<br />def login():<br />    username = flask.request.form.get('username')<br />    password = flask.request.form.get('password')<br /><br />    if not username:<br />        return "Must provide username\n"<br /><br />    if not password:<br />        return "Must provide password\n"<br /><br />    conn = sqlite3.connect(os.path.join(data_dir, 'users.db'))<br />    cursor = conn.cursor()<br /><br />    query = """SELECT id, password_hash, salt FROM users<br />               WHERE username = '{0}' LIMIT 1""".format(username)<br />    cursor.execute(query)<br /><br />    res = cursor.fetchone()<br />    if not res:<br />        return "There's no such user {0}!\n".format(username)<br />    user_id, password_hash, salt = res<br /><br />    calculated_hash = hashlib.sha256(password + salt)<br />    if calculated_hash.hexdigest() != password_hash:<br />        return "That's not the password for {0}!\n".format(username)</code></pre><h4>
    Issue
  </h4><p>
    There's little input validation on username before it is used to constrcut a SQL query. There's no encoding applied when constructing the SQL query string which is used to, given a username,
    produce the hashed password and the associated salt. Accordingly one can make username a part of a SQL query command which ensures the original select returns nothing and provide a new SELECT via
    a UNION that returns some literal values for the hash and salt. For instance the following in blue is the query template and the red is the username injected SQL code:
  </p><pre><code><span style="color:blue">SELECT id, password_hash, salt FROM users WHERE username = '</span><span style="color:red">doesntexist' UNION SELECT id, ('5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8') AS password_hash, ('word') AS salt FROM users WHERE username = 'bob</span><span style="color:blue;">' LIMIT 1</span></code></pre>In the above I've supplied my own salt and hash such that my salt (word) plus my password (pass) hashed produce the hash I provided above. Accordingly, by
  providing the above long and interesting looking username and password as 'pass' I can login as any user.
  <h4>
    Notes
  </h4><p>
    Code review red flag is again using strings to query the database. Although this level was made more difficult by using an API that returns only a single row and by using the execute method which
    only runs one command. I was forced to (as a SQL noob) learn <a href="http://www.sqlite.org/lang.html">the syntax of SELECT</a> in order to figure out UNION and how to return my own literal
    values.
  </p></div></div>

<ul class="links-nextprev"><li>Previous: <a href="/dave/2012-08/Stripe+Web+Security+CTF+Summary/">Stripe Web Security CTF Summary</a></li><li>Next: <a href="/dave/2012-09/Stripe+CTF+-+Input+validation+-Levels+1+-+2-/">Stripe CTF - Input validation (Levels 1 &amp; 2)</a></li>
</ul>

		</main>

		<footer></footer>

		<!-- Current page: /dave/2012-09/Stripe+CTF+-+SQL+injections+-Levels+0+-+3-/ -->
	</body>
</html>
